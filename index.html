<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T∆∞ v·∫•n tr·ª±c tuy·∫øn</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    #chat-box::-webkit-scrollbar, #history-box::-webkit-scrollbar { width: 6px; }
    #chat-box::-webkit-scrollbar-thumb, #history-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    #chat-box::-webkit-scrollbar-thumb:hover, #history-box::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="flex bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-7xl h-[800px]">

    <!-- Sidebar tr√°i -->
    <div class="w-1/4 bg-gray-100 p-6 flex flex-col border-r border-gray-200">
      <h1 class="text-3xl font-bold text-blue-600 mb-6">MEDIVERSE</h1>
      <h2 class="text-xl font-semibold text-gray-800 mb-4">T∆∞ v·∫•n tr·ª±c tuy·∫øn</h2>

      <!-- Menu -->
      <ul id="main-menu" class="space-y-3 font-medium text-lg">
        <li id="menu-doctor" class="p-3 rounded-xl hover:bg-gray-200 cursor-pointer flex items-center justify-between text-gray-700">
          <div class="flex items-center space-x-3"><i class="fas fa-user-md"></i><span>B√°c sƒ©</span></div>
          <i class="fas fa-chevron-right" id="arrow-doctor"></i>
        </li>
        <li id="menu-ai" class="p-3 rounded-xl hover:bg-gray-200 cursor-pointer flex items-center justify-between text-gray-700">
          <div class="flex items-center space-x-3"><i class="fas fa-robot"></i><span>Chatbot AI</span></div>
        </li>
        <li id="menu-history" class="p-3 rounded-xl hover:bg-gray-200 cursor-pointer flex items-center justify-between text-gray-700">
          <div class="flex items-center space-x-3"><i class="fas fa-history"></i><span>L·ªãch s·ª≠</span></div>
          <i class="fas fa-chevron-right" id="arrow-history"></i>
        </li>
      </ul>

      <!-- History list -->
      <div id="history-box" class="mt-4 flex-1 overflow-y-auto hidden"></div>
    </div>

    <!-- Chat box -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <div class="p-6 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-comments text-2xl text-blue-600"></i>
          <h2 id="chat-title" class="text-lg font-bold text-gray-800">Ch·ªçn m·ª•c b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2>
        </div>
      </div>

      <!-- Chat messages -->
      <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

      <!-- Input -->
      <div class="p-6 border-t border-gray-200 flex items-center space-x-3 bg-white">
        <input id="message-input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." class="flex-1 p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="send-btn" class="p-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>

    <!-- Sidebar ph·∫£i -->
    <div class="w-1/4 bg-gray-50 p-6 flex flex-col border-l border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Th√¥ng tin</h2>
      <div id="info-box" class="bg-white p-4 rounded-xl shadow-sm text-gray-600 mb-6">
        <p>Ch·ªçn t√≠nh nƒÉng t·ª´ menu b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
      </div>

      <h3 class="text-lg font-semibold text-gray-800 mb-3">FAQ</h3>
      <div class="faq-item bg-gray-200 p-2 rounded-xl cursor-pointer mb-2 hover:bg-gray-300">T√¥i n√™n u·ªëng thu·ªëc th·∫ø n√†o?</div>
      <div class="faq-item bg-gray-200 p-2 rounded-xl cursor-pointer mb-2 hover:bg-gray-300">Tri·ªáu ch·ª©ng n√†y c√≥ ƒë√°ng lo?</div>
    </div>
  </div>

<script>
  // ƒê√≥ng t·∫•t c·∫£ c√°c menu x·ªï xu·ªëng
  function resetMenuSections() {
    arrowDoctor.className = "fas fa-chevron-right";
    arrowHistory.className = "fas fa-chevron-right";
    historyBox.classList.add("hidden");
  }
  const API_URL = "https://mediverse-backend-aichat-production.up.railway.app";
  const userId = "user001";

  let activeConversationId = null;
  let activeDoctorConversationId = null;
  let activeMode = null; // "ai" | "doctor"

  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  const chatTitle = document.getElementById("chat-title");
  const infoBox = document.getElementById("info-box");
  const historyBox = document.getElementById("history-box");
  const arrowDoctor = document.getElementById("arrow-doctor");
  const arrowHistory = document.getElementById("arrow-history");

  /* -------------------- Helpers -------------------- */
  function addMessage(role, text) {
    const div = document.createElement("div");
    div.className = role === "user" ? "text-right" : "text-left";
    div.innerHTML = `
      <div class="inline-block px-4 py-2 rounded-xl ${
        role === "user" ? "bg-blue-600 text-white" : "bg-gray-200 text-gray-800"
      }">${marked.parse(text)}</div>`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function clearChat(title, info) {
    chatBox.innerHTML = "";
    chatTitle.textContent = title;
    infoBox.innerHTML = info;
  }

  /* -------------------- Start conversation -------------------- */
  async function startNewConversation(mode, doctorId = null) {
    if (mode === "ai") {
      const res = await fetch(`${API_URL}/conversation`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId }),
      });
      const data = await res.json();
      if (data.success) {
        // Backend tr·∫£ v·ªÅ conversation object
        activeConversationId = data.conversation?._id || data.id; 
        activeDoctorConversationId = null;
        activeMode = "ai";
        clearChat("Chatbot AI", "<p>Chat v·ªõi AI ü§ñ ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.</p>");
        addMessage("assistant", "Xin ch√†o, t√¥i l√† Chatbot AI ü§ñ. B·∫°n c·∫ßn g√¨?");
      } else {
        infoBox.innerHTML = `<p class="text-red-600">Kh√¥ng t·∫°o ƒë∆∞·ª£c h·ªôi tho·∫°i AI: ${data.error}</p>`;
      }
    }

    else if (mode === "doctor" && doctorId) {
      const res = await fetch(`${API_URL}/doctor-conversation`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, doctorId }),
      });
      const data = await res.json();
      if (data.success) {
        activeDoctorConversationId = data.conversation?._id || data.id;
        activeConversationId = null;
        activeMode = "doctor";
        const doctorInfo = data.doctor || data.conversation?.doctor || {};
        clearChat(
          `B√°c sƒ© ${doctorInfo.name || ""}`,
          `<p>B·∫°n ƒëang tr√≤ chuy·ªán v·ªõi b√°c sƒ© ${doctorInfo.name || "?"} (${doctorInfo.specialty || "?"})</p>`
        );
        addMessage(
          "assistant",
          `üë®‚Äç‚öïÔ∏è Xin ch√†o, t√¥i l√† b√°c sƒ© ${doctorInfo.name || "?"}, chuy√™n khoa ${doctorInfo.specialty || "?"}. H√£y cho t√¥i bi·∫øt tri·ªáu ch·ª©ng c·ªßa b·∫°n.`
        );
      } else {
        infoBox.innerHTML = `<p class="text-red-600">Kh√¥ng t·∫°o ƒë∆∞·ª£c h·ªôi tho·∫°i v·ªõi b√°c sƒ©: ${data.error}</p>`;
      }
    }
  }

  /* -------------------- Send message -------------------- */
  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage("user", text);
    input.value = "";

    try {
      if (activeMode === "ai" && activeConversationId) {
        const res = await fetch(`${API_URL}/chat/${activeConversationId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: text }),
        });
        const data = await res.json();
        addMessage("assistant", data.success ? data.answer : "‚ùå L·ªói: " + data.error);
      }

      if (activeMode === "doctor" && activeDoctorConversationId) {
        const res = await fetch(`${API_URL}/doctor-chat/${activeDoctorConversationId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: text }),
        });
        const data = await res.json();
        addMessage("assistant", data.success ? data.answer : "‚ùå L·ªói: " + data.error);
      }
    } catch (err) {
      addMessage("assistant", "‚ùå L·ªói k·∫øt n·ªëi server.");
    }
  }

  /* -------------------- Toggle -------------------- */
  function toggleSection(section) {
    if (section === "doctor") {
      const isOpen = arrowDoctor.classList.contains("fa-chevron-down");
      arrowDoctor.className = isOpen ? "fas fa-chevron-right" : "fas fa-chevron-down";
      return !isOpen;
    }
    if (section === "history") {
      const isOpen = arrowHistory.classList.contains("fa-chevron-down");
      arrowHistory.className = isOpen ? "fas fa-chevron-right" : "fas fa-chevron-down";
      historyBox.classList.toggle("hidden", isOpen);
      return !isOpen;
    }
  }


  /* -------------------- Menu AI -------------------- */
  document.getElementById("menu-ai").addEventListener("click", function() {
    resetMenuSections();
    setActiveMenu(this);
    startNewConversation("ai");
  });

  /* -------------------- Menu Doctor -------------------- */
  document.getElementById("menu-doctor").addEventListener("click", async function() {
    resetMenuSections();
    setActiveMenu(this);
    // Lu√¥n m·ªü menu b√°c sƒ©
    arrowDoctor.className = "fas fa-chevron-down";

    clearChat("Chat v·ªõi b√°c sƒ©", "<p>ƒêang t·∫£i d·ªØ li·ªáu b√°c sƒ©...</p>");

    const res = await fetch(`${API_URL}/doctor-info?userId=${userId}`);
    const data = await res.json();
    if (!data.success) {
      infoBox.innerHTML = "<p class='text-red-600'>Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu b√°c sƒ©.</p>";
      return;
    }

    let html = "<h3 class='font-bold mb-2'>B√°c sƒ© c·ªßa b·∫°n:</h3>";
    data.recent.forEach(doc => {
      html += `<div class='p-2 bg-gray-200 mb-2 rounded cursor-pointer hover:bg-gray-300'
                onclick="startNewConversation('doctor','${doc._id}')">
                üë®‚Äç‚öïÔ∏è ${doc.name} (${doc.specialty})
              </div>`;
    });
    if (data.suggested) {
      html += `<h3 class='font-bold mt-4 mb-2'>B√°c sƒ© g·ª£i √Ω:</h3>
              <div class='p-2 bg-blue-100 mb-2 rounded cursor-pointer hover:bg-blue-200'
                    onclick="startNewConversation('doctor','${data.suggested._id}')">
                    ‚≠ê ${data.suggested.name} (${data.suggested.specialty})
              </div>`;
    }
    infoBox.innerHTML = html;
  });

  /* -------------------- Menu History -------------------- */
  document.getElementById("menu-history").addEventListener("click", async function() {
    resetMenuSections();
    setActiveMenu(this);
    // Lu√¥n m·ªü menu l·ªãch s·ª≠
    arrowHistory.className = "fas fa-chevron-down";
    historyBox.classList.remove("hidden");

    historyBox.innerHTML = "<p>ƒêang t·∫£i l·ªãch s·ª≠...</p>";

    const res = await fetch(`${API_URL}/conversations/${userId}`);
    const data = await res.json();
    if (!data.success) {
      historyBox.innerHTML = "<p>L·ªói t·∫£i l·ªãch s·ª≠</p>";
    return;
    }
    historyBox.innerHTML = data.conversations.map(c => `
      <div class="history-item p-2 mb-2 bg-gray-200 rounded flex justify-between items-center cursor-pointer hover:bg-blue-100 transition">
        <span onclick="loadConversation('${c.id}', '${c.mode}', this)">üó®Ô∏è ${c.preview}</span>
        <i class="fas fa-trash text-red-500 hover:text-red-700 cursor-pointer ml-2"
          onclick="deleteConversation('${c.id}', this)"></i>
      </div>
    `).join("");
  });

  // Menu highlight
  const menuItems = document.querySelectorAll("#main-menu li");
  function setActiveMenu(el) {
    menuItems.forEach(item => item.classList.remove("bg-blue-600","text-white"));
    el.classList.add("bg-blue-600","text-white");
  }

  /* -------------------- Load conversation -------------------- */
  async function loadConversation(id, mode) {
    clearChat("ƒêang t·∫£i...", "");
    const res = await fetch(`${API_URL}/conversation/${id}`);
    const data = await res.json();

    if (data.success) {
      chatBox.innerHTML = "";
      activeConversationId = mode === "ai" ? id : null;
      activeDoctorConversationId = mode === "doctor" ? id : null;
      activeMode = mode;

      chatTitle.textContent = mode === "ai" ? "Chatbot AI" : `B√°c sƒ© ${data.doctor?.name || ""}`;

      // ch·ªâ l·∫•y 20 tin cu·ªëi
      const msgs = data.messages.slice(-20);
      msgs.forEach(m => addMessage(m.role, m.content));
    } else {
      addMessage("assistant", "‚ùå L·ªói t·∫£i h·ªôi tho·∫°i.");
    }
  }
  
  // History highlight
  function setActiveHistory(el) {
    document.querySelectorAll("#history-box .history-item")
      .forEach(item => item.classList.remove("bg-blue-100","font-bold","text-blue-600"));
    el.classList.add("bg-blue-100","font-bold","text-blue-600");
  }

  // X√≥a h·ªôi tho·∫°i
  async function deleteConversation(id, el) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªôi tho·∫°i n√†y?")) return;
    const res = await fetch(`${API_URL}/conversation/${id}`, { method: "DELETE" });
    const data = await res.json();
    if (data.success) el.parentElement.remove();
    else alert("‚ùå Kh√¥ng x√≥a ƒë∆∞·ª£c h·ªôi tho·∫°i");
  }

  /* -------------------- Send button -------------------- */
  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

  /* -------------------- Auto m·ªü AI khi load trang -------------------- */
  window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("menu-ai").click();
  });
</script>
</body>
</html>
